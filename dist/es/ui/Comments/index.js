import e,{useState as t,useEffect as n,useCallback as r}from"react";import o,{gql as a}from"apollo-boost";import{ApolloProvider as i,useQuery as u,useMutation as m}from"@apollo/react-hooks";import c from"date-fns/formatDistanceToNow";function l(e,t,n,r,o,a,i){try{var u=e[a](i),m=u.value}catch(e){return void n(e)}u.done?t(m):Promise.resolve(m).then(r,o)}function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function s(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function p(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e))&&"[object Arguments]"!==Object.prototype.toString.call(e))return;var n=[],r=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==u.return||u.return()}finally{if(o)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function _(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===n&&r.firstChild?r.insertBefore(o,r.firstChild):r.appendChild(o),o.styleSheet?o.styleSheet.cssText=e:o.appendChild(document.createTextNode(e))}}var h="textArea-module_textArea__jOs0v",x="textArea-module_normal__252TE",v="textArea-module_notFocused__39uMv",g="textArea-module_promo__6uESg";_(".textArea-module_textArea__jOs0v {\n  border-radius: 5px;\n  width: calc(100% - 20px - 10px - 2px);\n  padding: 10px;\n  margin: 5px;\n  border: 1.5px solid;\n  resize: none;\n  font-family: inherit;\n  font-size: inherit; }\n  .textArea-module_textArea__jOs0v:focus {\n    outline: none; }\n\n.textArea-module_message__356sA {\n  height: 70px;\n  width: 100%; }\n\n.textArea-module_normal__252TE {\n  border-color: #288ce4; }\n\n.textArea-module_notFocused__39uMv {\n  color: #b7b7b7 !important;\n  border-color: #b7b7b7 !important; }\n\n.textArea-module_error__3cOzU {\n  border-color: red !important; }\n\n.textArea-module_promo__6uESg {\n  float: right;\n  font-size: 10px;\n  margin-top: -3px;\n  margin-right: 5px; }\n");var y=e.memo((function(r){var o=r.onSubmit,a=r.setInputState,i=r.inputState,u=p(t(!1),2),m=u[0],c=u[1],l=p(t(""),2),d=l[0],s=l[1],f=!1;n((function(){var e;return"done"===i&&(e=setTimeout((function(){c(!1),a("ready")}),2e3)),function(){e&&clearTimeout(e)}}),[i,a]);var _=function(e){if(13===e.keyCode&&!1===e.shiftKey){f=!0;var t=d.trim();if(0===t.length)return;return o(t),void s("")}if(f)f=!1;else{var n=e.target.value||"";s(n)}},y=[h];return m?y.push(x):y.push(v),e.createElement(e.Fragment,null,["sending","done"].includes(i)?"DONE":e.createElement("textarea",{value:d,onChange:_,onKeyDown:_,onFocus:function(){return c(!0)},onBlur:function(){return c(!1)},className:y.join(" "),placeholder:"Join the discussion..."}),e.createElement("div",{className:g},"Power by ",e.createElement("a",{href:"https://chimp.click",rel:"noopener noreferrer",target:"_blank"},"chimp.click")))})),b="comment-module_comment__1VBGu",A="comment-module_headerWrapper__2zqKy",w="comment-module_profilePhoto__1OoMA",E="comment-module_name__1-F6F",S="comment-module_date__2-IUq",O="comment-module_text__1W5B4";_(".comment-module_comment__1VBGu {\n  display: flex;\n  padding: 5px;\n  text-align: start;\n  word-break: break-all; }\n  .comment-module_comment__1VBGu .comment-module_headerWrapper__2zqKy {\n    display: flex; }\n  .comment-module_comment__1VBGu .comment-module_profilePhoto__1OoMA {\n    height: 35px;\n    width: 35px;\n    border-radius: 5px;\n    margin-right: 5px; }\n  .comment-module_comment__1VBGu .comment-module_name__1-F6F {\n    color: #288ce4;\n    font-size: 10px;\n    font-weight: bold; }\n  .comment-module_comment__1VBGu .comment-module_date__2-IUq {\n    font-size: 10px;\n    padding-left: 5px; }\n  .comment-module_comment__1VBGu .comment-module_text__1W5B4 {\n    margin: 0px;\n    white-space: pre-wrap;\n    overflow-wrap: break-word; }\n");var j=function(t){var n=t.text,o=t.user,a=t.createdAt,i=t.users,u=r((function(){return c(new Date(a),{addSuffix:!0})}),[a]);return e.createElement("div",{className:b},i[o]&&i[o].image&&e.createElement("img",{className:w,src:i[o].image,alt:i[o].name}),e.createElement("div",null,e.createElement("div",{className:A},e.createElement("div",{className:E},i[o]?i[o].name:"Unknown user"),e.createElement("div",{className:S},u())),e.createElement("p",{className:O},n)))};function C(){var e=s(["\n  mutation createComment($text: String!, $code: String!, $user: String) {\n    createComment(data: { text: $text, code: $code, user: $user }) {\n      id\n      text\n      createdAt\n      user\n    }\n  }\n"]);return C=function(){return e},e}function N(){var e=s(["\n  query getComments($code: String!) {\n    getComments(where: { code: $code }) {\n      id\n      text\n      createdAt\n      user\n    }\n  }\n"]);return N=function(){return e},e}var k=new o({uri:"http://localhost:8080/graphql"}),z=a(N()),B=a(C()),T=function(o){var a=o.code,i=o.authKey,c=o.users,s=o.user,_=p(t([]),2),h=_[0],x=_[1],v=u(z,{variables:{code:a},context:{headers:{authorization:i}}}),g=v.loading,b=v.data,A=v.refetch,w=p(m(B),1)[0],E=p(t("ready"),2),S=E[0],O=E[1],C=r(function(){var e,t=(e=regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return O("sending"),e.next=3,w({variables:{text:t,code:a,user:s},context:{headers:{authorization:i}}});case 3:n=e.sent,r=n.data.createComment,x([r].concat(f(h))),O("done");case 7:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){l(a,r,o,i,u,"next",e)}function u(e){l(a,r,o,i,u,"throw",e)}i(void 0)}))});return function(e){return t.apply(this,arguments)}}(),[w,i,h,a]);return n((function(){x([]),A()}),[A,a,i]),e.createElement("div",null,s&&e.createElement(y,{onSubmit:C,inputState:S,setInputState:O}),g?"LOADING":e.createElement(e.Fragment,null,0===h.length&&0===b.getComments.length?"EMPTY":e.createElement(e.Fragment,null,h.map((function(t){return e.createElement(j,d({key:t.id},t,{users:c}))})),b.getComments.map((function(t){return e.createElement(j,d({key:t.id},t,{users:c}))})))))};export default function(t){var n=t.code,r=t.authKey,o=t.users,a=t.user;return e.createElement(i,{client:k},e.createElement(T,{code:n,authKey:r,users:o,user:a}))}
