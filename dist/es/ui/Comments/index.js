import e,{useState as t,useEffect as n,useCallback as r,useRef as o}from"react";import{ApolloProvider as a,useQuery as i,useMutation as c,useSubscription as m}from"@apollo/react-hooks";import u from"date-fns/formatDistanceToNow";import s from"apollo-client";import{createHttpLink as l}from"apollo-link-http";import{InMemoryCache as p}from"apollo-cache-inmemory";import{setContext as d}from"apollo-link-context";import{WebSocketLink as f}from"apollo-link-ws";import{split as h}from"apollo-link";import{getMainDefinition as _}from"apollo-utilities";import{gql as g}from"apollo-boost";function y(e,t,n,r,o,a,i){try{var c=e[a](i),m=c.value}catch(e){return void n(e)}c.done?t(m):Promise.resolve(m).then(r,o)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function x(){return(x=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){v(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function A(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function E(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e))&&"[object Arguments]"!==Object.prototype.toString.call(e))return;var n=[],r=!0,o=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(r=(i=c.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function O(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function T(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===n&&r.firstChild?r.insertBefore(o,r.firstChild):r.appendChild(o),o.styleSheet?o.styleSheet.cssText=e:o.appendChild(document.createTextNode(e))}}var N="textArea-module_textArea__jOs0v",j="textArea-module_normal__252TE",C="textArea-module_notFocused__39uMv";T(".textArea-module_textArea__jOs0v {\n  border-radius: 5px;\n  width: calc(100% - 20px - 10px - 2px);\n  padding: 10px;\n  margin: 5px;\n  border: 1.5px solid;\n  resize: none;\n  font-family: inherit;\n  font-size: inherit; }\n  .textArea-module_textArea__jOs0v:focus {\n    outline: none; }\n\n.textArea-module_message__356sA {\n  height: 70px;\n  width: 100%; }\n\n.textArea-module_normal__252TE {\n  border-color: #288ce4; }\n\n.textArea-module_notFocused__39uMv {\n  color: #b7b7b7 !important;\n  border-color: #b7b7b7 !important; }\n\n.textArea-module_error__3cOzU {\n  border-color: red !important; }\n\n.textArea-module_promo__6uESg {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  float: right;\n  font-size: 10px;\n  margin-top: -3px;\n  margin-right: 5px; }\n  .textArea-module_promo__6uESg img {\n    width: 30px; }\n");var S=e.memo((function(r){var o=r.className,a=r.onSubmit,i=r.setInputState,c=r.inputState,m=r.placeholder,u=E(t(!1),2),s=u[0],l=u[1],p=E(t(""),2),d=p[0],f=p[1],h=!1;n((function(){return function(){void 0}}),[c,i]);var _=function(e){if(13===e.keyCode&&!1===e.shiftKey){h=!0;var t=d.trim();if(0===t.length)return;return a(t),void f("")}if(h)h=!1;else{var n=e.target.value||"";"\n"!==n&&f(n)}},g=[N,o];return s?g.push(j):g.push(C),e.createElement(e.Fragment,null,e.createElement("textarea",{value:d,onChange:_,onKeyDown:_,onFocus:function(){return l(!0)},onBlur:function(){return l(!1)},className:g.join(" "),placeholder:m}))})),P={comment:"comment-module_comment__1VBGu",headerWrapper:"comment-module_headerWrapper__2zqKy",profilePhoto:"comment-module_profilePhoto__1OoMA",name:"comment-module_name__1-F6F",date:"comment-module_date__2-IUq",text:"comment-module_text__1W5B4"};T(".comment-module_comment__1VBGu {\n  display: flex;\n  padding: 5px;\n  text-align: start;\n  word-break: break-all; }\n  .comment-module_comment__1VBGu .comment-module_headerWrapper__2zqKy {\n    display: flex; }\n  .comment-module_comment__1VBGu .comment-module_profilePhoto__1OoMA {\n    height: 35px;\n    width: 35px;\n    border-radius: 5px;\n    margin-right: 5px; }\n  .comment-module_comment__1VBGu .comment-module_name__1-F6F {\n    color: #288ce4;\n    font-size: 10px;\n    font-weight: bold; }\n  .comment-module_comment__1VBGu .comment-module_date__2-IUq {\n    font-size: 10px;\n    padding-left: 5px; }\n  .comment-module_comment__1VBGu .comment-module_text__1W5B4 {\n    margin: 0px;\n    white-space: pre-wrap;\n    overflow-wrap: break-word; }\n");var k=function(t){var n=t.showMessageTime,o=t.messageTextClassName,a=t.messageHeaderClassName,i=t.text,c=t.user,m=t.createdAt,s=t.users,l=t.authenticationType,p=r((function(){return u(new Date(m),{addSuffix:!0})}),[m]),d="simple"===l;return e.createElement("div",{className:P.comment},s[c]&&s[c].image&&e.createElement("img",{className:P.profilePhoto,src:s[c].image,alt:s[c].name}),e.createElement("div",null,e.createElement("div",{className:[P.headerWrapper,a].join(" ")},e.createElement("div",{className:P.name},d?c:s[c]?s[c].name:"Unknown user"),n&&e.createElement("div",{className:P.date},p())),e.createElement("p",{className:[P.text,o].join(" ")},i)))},z=function(e){return"".concat(e,"://").concat("suite.chimp.click","/graphql")};var B="top",M=B;function $(){var e=A(["\n\tmutation createComment($text: String!, $code: String!, $user: String!, $authenticationType: AuthenticationType!) {\n\t\tcreateComment(data: { text: $text, code: $code, user: $user, authenticationType: $authenticationType }) {\n\t\t\tid\n\t\t\ttext\n\t\t\tcreatedAt\n\t\t\tuser\n\t\tauthenticationType,\n\t\t}\n\t}\n"]);return $=function(){return e},e}function D(){var e=A(["\n\tsubscription newComment($code: String!) {\n\t\tnewComment (code: $code) {\n\t\t\tid\n\t\t\ttext\n\t\t\tcreatedAt\n\t\t\tuser\n\t\t\tauthenticationType\n\t\t}\n\t}\n"]);return D=function(){return e},e}function F(){var e=A(["\n\tquery getComments($code: String!) {\n\t\tgetComments(where: { code: $code }) {\n\t\t\tid\n\t\t\ttext\n\t\t\tcreatedAt\n\t\t\tuser\n\t\tauthenticationType\n\t\t}\n\t}\n"]);return F=function(){return e},e}var G=g(F()),I=g(D()),W=g($()),q=function(a){var u=a.showMessageTime,s=a.wrapperClassName,l=a.textAreaClassName,p=a.messagesAreaClassName,d=a.messageHeaderClassName,f=a.messageTextClassName,h=a.showTextWhenEmpty,_=a.code,g=a.authKey,v=a.users,b=a.user,w=a.authenticationType,A=a.direction,T=o(),N=E(t([]),2),j=N[0],C=N[1],P=i(G,{variables:{code:_}}),z=P.loading,M=P.data,$=P.refetch,D=E(c(W),1)[0],F=r((function(e){var t=e.subscriptionData.data.newComment;C(A===B?[t].concat(O(j)):[].concat(O(j),[t]))}),[C,j,T]);m(I,{onSubscriptionData:F,variables:{code:_}});var q=E(t("ready"),2),V=q[0],K=q[1],H=r(function(){var e,t=(e=regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D({variables:{authenticationType:w,text:t,code:_,user:b}});case 2:K("done");case 3:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){y(a,r,o,i,c,"next",e)}function c(e){y(a,r,o,i,c,"throw",e)}i(void 0)}))});return function(e){return t.apply(this,arguments)}}(),[D,g,j,_]);n((function(){C([]),$()}),[$,_,g]),n((function(){T.current&&(T.current.scrollTop=Number.MAX_SAFE_INTEGER)}));var R=r((function(){return A===B?M.getComments:M.getComments.reverse()}),[M,A]),U=A===B;T.current&&(T.current.scrollTop=Number.MAX_SAFE_INTEGER);var L=b&&e.createElement(S,{className:l,onSubmit:H,inputState:V,setInputState:K,placeholder:a.textAreaPlaceholder}),X=j.map((function(t){return e.createElement(k,x({key:t.id},t,{users:v,messageTextClassName:f,messageHeaderClassName:d,showMessageTime:u}))}));return e.createElement("div",{className:s},U&&L,z?"LOADING":e.createElement(e.Fragment,null,h&&0===j.length&&0===M.getComments.length?"EMPTY":e.createElement("div",{className:p,ref:T,style:{height:100,overflow:"auto"}},U&&X,R().map((function(t){return e.createElement(k,x({key:t.id},t,{users:v,messageTextClassName:f,messageHeaderClassName:d,showMessageTime:u}))})),!U&&X)),!U&&L)},V=function(t){var n,r,o,i,c=t.authKey;return e.createElement(a,{client:(n=c,r=l({uri:z("http".concat("s"))}),o=new f({uri:z("ws".concat("s")),options:{lazy:!0,reconnect:!0,connectionParams:function(){return{headers:{authorization:n}}}}}),i=d((function(e,t){return{headers:w({},t.headers,{authorization:n}),onError:function(e){var t=e.graphQLErrors,n=e.networkError;t&&console.error(t),n&&console.error("[Network error]: ".concat(n))}}})),new s({link:h((function(e){var t=e.query,n=_(t);return"OperationDefinition"===n.kind&&"subscription"===n.operation}),o,i.concat(r)),cache:new p}))},e.createElement(q,t))};V.defaultProps={direction:M,textAreaPlaceholder:"Join the discussion...",showTextWhenEmpty:!1,showMessageTime:!0};export default V;
