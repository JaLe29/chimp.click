"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),React__default=_interopDefault(React),reactHooks=require("@apollo/react-hooks"),formatDistanceToNow=_interopDefault(require("date-fns/formatDistanceToNow")),ApolloClient=_interopDefault(require("apollo-client")),apolloLinkHttp=require("apollo-link-http"),apolloCacheInmemory=require("apollo-cache-inmemory"),apolloLinkContext=require("apollo-link-context"),apolloLinkWs=require("apollo-link-ws"),apolloLink=require("apollo-link"),apolloUtilities=require("apollo-utilities"),apolloBoost=require("apollo-boost");function asyncGeneratorStep(e,t,n,r,a,o,c){try{var i=e[o](c),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(r,a)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function c(e){asyncGeneratorStep(o,r,a,c,i,"next",e)}function i(e){asyncGeneratorStep(o,r,a,c,i,"throw",e)}c(void 0)}))}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _taggedTemplateLiteral(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,a=!1,o=void 0;try{for(var c,i=e[Symbol.iterator]();!(r=(c=i.next()).done)&&(n.push(c.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==i.return||i.return()}finally{if(a)throw o}}return n}}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function styleInject(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style");a.type="text/css","top"===n&&r.firstChild?r.insertBefore(a,r.firstChild):r.appendChild(a),a.styleSheet?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e))}}var css=".textArea-module_textArea__jOs0v {\n  border-radius: 5px;\n  width: calc(100% - 20px - 10px - 2px);\n  padding: 10px;\n  margin: 5px;\n  border: 1.5px solid;\n  resize: none;\n  font-family: inherit;\n  font-size: inherit; }\n  .textArea-module_textArea__jOs0v:focus {\n    outline: none; }\n\n.textArea-module_message__356sA {\n  height: 70px;\n  width: 100%; }\n\n.textArea-module_normal__252TE {\n  border-color: #288ce4; }\n\n.textArea-module_notFocused__39uMv {\n  color: #b7b7b7 !important;\n  border-color: #b7b7b7 !important; }\n\n.textArea-module_error__3cOzU {\n  border-color: red !important; }\n\n.textArea-module_promo__6uESg {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  float: right;\n  font-size: 10px;\n  margin-top: -3px;\n  margin-right: 5px; }\n  .textArea-module_promo__6uESg img {\n    width: 30px; }\n",css$1={textArea:"textArea-module_textArea__jOs0v",message:"textArea-module_message__356sA",normal:"textArea-module_normal__252TE",notFocused:"textArea-module_notFocused__39uMv",error:"textArea-module_error__3cOzU",promo:"textArea-module_promo__6uESg"};styleInject(css);var TextArea=function(e){var t=e.className,n=e.onSubmit,r=e.setInputState,a=e.inputState,o=e.placeholder,c=_slicedToArray(React.useState(!1),2),i=c[0],l=c[1],s=_slicedToArray(React.useState(""),2),u=s[0],m=s[1],p=!1;React.useEffect((function(){return function(){void 0}}),[a,r]);var d=function(e){if(13===e.keyCode&&!1===e.shiftKey){p=!0;var t=u.trim();if(0===t.length)return;return n(t),void m("")}if(p)p=!1;else{var r=e.target.value||"";"\n"!==r&&m(r)}},_=[css$1.textArea,t];return i?_.push(css$1.normal):_.push(css$1.notFocused),React__default.createElement(React__default.Fragment,null,React__default.createElement("textarea",{value:u,onChange:d,onKeyDown:d,onFocus:function(){return l(!0)},onBlur:function(){return l(!1)},className:_.join(" "),placeholder:o}))},TextArea$1=React__default.memo(TextArea),css$2=".comment-module_comment__1VBGu {\n  display: flex;\n  padding: 5px;\n  text-align: start;\n  word-break: break-all; }\n  .comment-module_comment__1VBGu .comment-module_headerWrapper__2zqKy {\n    display: flex; }\n  .comment-module_comment__1VBGu .comment-module_profilePhoto__1OoMA {\n    height: 35px;\n    width: 35px;\n    border-radius: 5px;\n    margin-right: 5px; }\n  .comment-module_comment__1VBGu .comment-module_name__1-F6F {\n    color: #288ce4;\n    font-size: 10px;\n    font-weight: bold; }\n  .comment-module_comment__1VBGu .comment-module_date__2-IUq {\n    font-size: 10px;\n    padding-left: 5px; }\n  .comment-module_comment__1VBGu .comment-module_text__1W5B4 {\n    margin: 0px;\n    white-space: pre-wrap;\n    overflow-wrap: break-word; }\n",css$3={comment:"comment-module_comment__1VBGu",headerWrapper:"comment-module_headerWrapper__2zqKy",profilePhoto:"comment-module_profilePhoto__1OoMA",name:"comment-module_name__1-F6F",date:"comment-module_date__2-IUq",text:"comment-module_text__1W5B4"};styleInject(css$2);var Comment=function(e){var t=e.showMessageTime,n=e.messageTextClassName,r=e.messageHeaderClassName,a=e.text,o=e.user,c=e.createdAt,i=e.users,l=e.authenticationType,s=React.useCallback((function(){return formatDistanceToNow(new Date(c),{addSuffix:!0})}),[c]),u="simple"===l;return React__default.createElement("div",{className:css$3.comment},i[o]&&i[o].image&&React__default.createElement("img",{className:css$3.profilePhoto,src:i[o].image,alt:i[o].name}),React__default.createElement("div",null,React__default.createElement("div",{className:[css$3.headerWrapper,r].join(" ")},React__default.createElement("div",{className:css$3.name},u?o:i[o]?i[o].name:"Unknown user"),t&&React__default.createElement("div",{className:css$3.date},s())),React__default.createElement("p",{className:[css$3.text,n].join(" ")},a)))},HOST="suite.chimp.click",uri=function(e){return"".concat(e,"://").concat(HOST,"/graphql")};function apolloClient(e){var t=apolloLinkHttp.createHttpLink({uri:uri("http".concat("s"))}),n=new apolloLinkWs.WebSocketLink({uri:uri("ws".concat("s")),options:{lazy:!0,reconnect:!0,connectionParams:function(){return{headers:{authorization:e}}}}}),r=apolloLinkContext.setContext((function(t,n){return{headers:_objectSpread2({},n.headers,{authorization:e}),onError:function(e){var t=e.graphQLErrors,n=e.networkError;t&&console.error(t),n&&console.error("[Network error]: ".concat(n))}}}));return new ApolloClient({link:apolloLink.split((function(e){var t=e.query,n=apolloUtilities.getMainDefinition(t);return"OperationDefinition"===n.kind&&"subscription"===n.operation}),n,r.concat(t)),cache:new apolloCacheInmemory.InMemoryCache})}var DIRECTION={TOP:"top",BOTTOM:"bottom"},DEFAULT_DIRECTION=DIRECTION.TOP,DEFAULT_TEXT_AREA_PLACEHOLDER="Join the discussion...";function _templateObject3(){var e=_taggedTemplateLiteral(["\n\tmutation createComment($text: String!, $code: String!, $user: String!, $authenticationType: AuthenticationType!) {\n\t\tcreateComment(data: { text: $text, code: $code, user: $user, authenticationType: $authenticationType }) {\n\t\t\tid\n\t\t\ttext\n\t\t\tcreatedAt\n\t\t\tuser\n\t\tauthenticationType,\n\t\t}\n\t}\n"]);return _templateObject3=function(){return e},e}function _templateObject2(){var e=_taggedTemplateLiteral(["\n\tsubscription newComment($code: String!) {\n\t\tnewComment (code: $code) {\n\t\t\tid\n\t\t\ttext\n\t\t\tcreatedAt\n\t\t\tuser\n\t\t\tauthenticationType\n\t\t}\n\t}\n"]);return _templateObject2=function(){return e},e}function _templateObject(){var e=_taggedTemplateLiteral(["\n\tquery getComments($code: String!) {\n\t\tgetComments(where: { code: $code }) {\n\t\t\tid\n\t\t\ttext\n\t\t\tcreatedAt\n\t\t\tuser\n\t\tauthenticationType\n\t\t}\n\t}\n"]);return _templateObject=function(){return e},e}var GET_COMMENTS=apolloBoost.gql(_templateObject()),SUBSCRIBE_NEW_COMMENT=apolloBoost.gql(_templateObject2()),ADD_COMMENT=apolloBoost.gql(_templateObject3()),Comments=function(e){var t=e.showMessageTime,n=e.wrapperClassName,r=e.textAreaClassName,a=e.messagesAreaClassName,o=e.messageHeaderClassName,c=e.messageTextClassName,i=e.showTextWhenEmpty,l=e.code,s=e.authKey,u=e.users,m=e.user,p=e.authenticationType,d=e.direction,_=React.useRef(),f=_slicedToArray(React.useState([]),2),h=f[0],y=f[1],g=reactHooks.useQuery(GET_COMMENTS,{variables:{code:l}}),b=g.loading,x=g.data,T=g.refetch,A=_slicedToArray(reactHooks.useMutation(ADD_COMMENT),1)[0],v=React.useCallback((function(e){var t=e.subscriptionData.data.newComment,n=d===DIRECTION.TOP;y(n?[t].concat(_toConsumableArray(h)):[].concat(_toConsumableArray(h),[t]))}),[y,h,_]);reactHooks.useSubscription(SUBSCRIBE_NEW_COMMENT,{onSubscriptionData:v,variables:{code:l}});var E=_slicedToArray(React.useState("ready"),2),O=E[0],C=E[1],w=React.useCallback(function(){var e=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A({variables:{authenticationType:p,text:t,code:l,user:m}});case 2:C("done");case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[A,s,h,l]);React.useEffect((function(){y([]),T()}),[T,l,s]),React.useEffect((function(){_.current&&(_.current.scrollTop=Number.MAX_SAFE_INTEGER)}));var R=React.useCallback((function(){return d===DIRECTION.TOP?x.getComments:x.getComments.reverse()}),[x,d]),N=d===DIRECTION.TOP;_.current&&(_.current.scrollTop=Number.MAX_SAFE_INTEGER);var S=m&&React__default.createElement(TextArea$1,{className:r,onSubmit:w,inputState:O,setInputState:C,placeholder:e.textAreaPlaceholder}),j=h.map((function(e){return React__default.createElement(Comment,_extends({key:e.id},e,{users:u,messageTextClassName:c,messageHeaderClassName:o,showMessageTime:t}))}));return React__default.createElement("div",{className:n},N&&S,b?"LOADING":React__default.createElement(React__default.Fragment,null,i&&0===h.length&&0===x.getComments.length?"EMPTY":React__default.createElement("div",{className:a,ref:_,style:{height:100,overflow:"auto"}},N&&j,R().map((function(e){return React__default.createElement(Comment,_extends({key:e.id},e,{users:u,messageTextClassName:c,messageHeaderClassName:o,showMessageTime:t}))})),!N&&j)),!N&&S)},CommentsWrapper=function(e){var t=e.authKey;return React__default.createElement(reactHooks.ApolloProvider,{client:apolloClient(t)},React__default.createElement(Comments,e))};CommentsWrapper.defaultProps={direction:DEFAULT_DIRECTION,textAreaPlaceholder:DEFAULT_TEXT_AREA_PLACEHOLDER,showTextWhenEmpty:!1,showMessageTime:!0},exports.default=CommentsWrapper;
